<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>WebCam over WebSocket</title>
  </head>
  <body onload="init()">
    <h2> Remote Webcam using Opera, Web Sockets and HTML5/Canvas </h1>
    <video autoplay="true" id="sourcevid"></video>
    <canvas id="output"></canvas>
    <div id="log"></div>
    <script type="text/javascript">
      var log = function(msg) {
        document.getElementById('log').innerHTML = document.getElementById('log').innerHTML + msg + "<br/>";
      };

      var video = document.getElementsByTagName('video')[0];
      var heading = document.getElementsByTagName('h1')[0];
      if(navigator.getUserMedia) {
        function successCallback( stream ) {
          video.src = stream;
        };
        function errorCallback( error ) {
          heading.textContent = "An error occurred: [CODE " + error.code + "]";
        };
        navigator.getUserMedia('video', successCallback, errorCallback);
      } else {
        heading.textContent = "Native web camera streaming is not supported in this browser!";
      };

      var webSocket;
      var videoOutput = document.createElement('canvas');
      var videoOutputContext = videoOutput.getContext('2d');

      if ('MozWebSocket' in window) {
          window.WebSocket = window.MozWebSocket;
      }

      if ('WebSocket' in window) {
        webSocket = connect("${web.socket.location}");
      } else {
        log ('web sockets not supported');
      }

      function connect(host) {
        webSocket = new WebSocket(host);
        webSocket.onopen = function () {
          log('connected');
        };

        webSocket.onclose = function () {
          log('socket closed');
        };

        webSocket.onerror = function (evt) {
            log('socket error: ' + evt.data);
        };
      };

      function sendFrame(ws, msg){
        if(ws.readyState === 1) {
          ws.send(msg);
        }
      }    

      function draw(video, videoOutputContext, width, height) {
        // First, draw it into the videoOutputing canvas
        videoOutputContext.drawImage(video, 0, 0, width, height);

          // Grab the pixel data from the videoOutputing canvas
        var stringData=videoOutput.toDataURL();

        // send it on the wire
        if (webSocket != null) {
          sendFrame(webSocket,stringData);
        }

        // Start over! 10 frames a second = 100milliseconds
        setTimeout(function(){ draw(video, videoOutputContext, width, height); });
      }
    
      function init() {
        var width = 120;//240; //video.clientWidth;
        var height = 200;//400; //video.clientHeight;

        videoOutput.width = width;
        videoOutput.height = height;
        draw(video, videoOutputContext, width, height);
      }
    </script>
  </body>
</html>
