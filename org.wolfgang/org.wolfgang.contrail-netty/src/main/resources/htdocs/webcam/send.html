<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>WebCam over WebSocket</title>
  </head>
  <body>
    <h2> Remote Webcam using Opera, Web Sockets and HTML5/Canvas </h1>
    <video autoplay="true" id="sourcevid"></video>
    <canvas id="output"></canvas>
    <div id="log"></div>
    <script type="text/javascript">
      var log = function(msg) {
        document.getElementById('log').innerHTML = msg ;
      };

      var videoSource = document.getElementsByTagName('video')[0];
      var heading = document.getElementsByTagName('h1')[0];
      
      if(navigator.getUserMedia) {
        function successCallback( stream ) {
          videoSource.src = stream;
        };
        function errorCallback( error ) {
          heading.textContent = "An error occurred: [CODE " + error.code + "]";
        };
        navigator.getUserMedia('video', successCallback, errorCallback);
      } else {
        heading.textContent = "Native web camera streaming is not supported in this browser!";
      };

      if ('MozWebSocket' in window) {
          window.WebSocket = window.MozWebSocket;
      }

      if ('WebSocket' in window) {
        connect("${web.socket.location}");
      } else {
        log ('web sockets not supported');
      }

      function connect(host) {
        var localWebSocket = new WebSocket(host);
        
        localWebSocket.onopen = function () {
          log('connected');
          setTimeout(init(this),100);
        };

        localWebSocket.onclose = function () {
          log('socket closed');
        };

        localWebSocket.onerror = function (evt) {
            log('socket error: ' + evt.data);
        };
      };

      function sendFrame(ws, msg){
        if(ws.readyState == 1) {
          ws.send(msg);
        }
      }    

      function draw(webSocket, videoSource, videoOutputCanvas, width, height) {
        try {
          var videoOutputCanvasContext = videoOutputCanvas.getContext("2d");
          videoOutputCanvasContext.drawImage(videoSource, 0, 0, width, height);

          if (webSocket != null) {
          	webSocket.send(videoOutputCanvas.toDataURL());
          }
        } catch (e) {
         log(e);
        }
        
        setTimeout(function(){ draw(webSocket, videoSource, videoOutputCanvas, width, height); },100);
      }
    
      function init(webSocket) {
      	var videoOutputCanvas = document.createElement('canvas');
        
        var width = 120;//240; //video.clientWidth;
        var height = 200;//400; //video.clientHeight;

        videoOutputCanvas.width = width;
        videoOutputCanvas.height = height;
        
        return function() { draw(webSocket, videoSource, videoOutputCanvas, width, height) };
      }
    </script>
  </body>
</html>
